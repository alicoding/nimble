/*!
 * EventEmitter v4.2.7 - git.io/ee
 * Oliver Caldwell
 * MIT license
 * @preserve
 */

/**
   * To Title Case 2.1 - http://individed.com/code/to-title-case/
   * Copyright 2008-2013 David Gouch. Licensed under the MIT License.
   * https://github.com/gouch/to-title-case
   */

(function(){function e(){}function t(e,t){for(var r=e.length;r--;)if(e[r].listener===t)return r;return-1}function r(e){return function(){return this[e].apply(this,arguments)}}var n=e.prototype,s=this,a=s.EventEmitter;n.getListeners=function(e){var t,r,n=this._getEvents();if(e instanceof RegExp){t={};for(r in n)n.hasOwnProperty(r)&&e.test(r)&&(t[r]=n[r])}else t=n[e]||(n[e]=[]);return t},n.flattenListeners=function(e){var t,r=[];for(t=0;t<e.length;t+=1)r.push(e[t].listener);return r},n.getListenersAsObject=function(e){var t,r=this.getListeners(e);return r instanceof Array&&(t={},t[e]=r),t||r},n.addListener=function(e,r){var n,s=this.getListenersAsObject(e),a="object"==typeof r;for(n in s)s.hasOwnProperty(n)&&-1===t(s[n],r)&&s[n].push(a?r:{listener:r,once:!1});return this},n.on=r("addListener"),n.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},n.once=r("addOnceListener"),n.defineEvent=function(e){return this.getListeners(e),this},n.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},n.removeListener=function(e,r){var n,s,a=this.getListenersAsObject(e);for(s in a)a.hasOwnProperty(s)&&(n=t(a[s],r),-1!==n&&a[s].splice(n,1));return this},n.off=r("removeListener"),n.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},n.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},n.manipulateListeners=function(e,t,r){var n,s,a=e?this.removeListener:this.addListener,i=e?this.removeListeners:this.addListeners;if("object"!=typeof t||t instanceof RegExp)for(n=r.length;n--;)a.call(this,t,r[n]);else for(n in t)t.hasOwnProperty(n)&&(s=t[n])&&("function"==typeof s?a.call(this,n,s):i.call(this,n,s));return this},n.removeEvent=function(e){var t,r=typeof e,n=this._getEvents();if("string"===r)delete n[e];else if(e instanceof RegExp)for(t in n)n.hasOwnProperty(t)&&e.test(t)&&delete n[t];else delete this._events;return this},n.removeAllListeners=r("removeEvent"),n.emitEvent=function(e,t){var r,n,s,a,i=this.getListenersAsObject(e);for(s in i)if(i.hasOwnProperty(s))for(n=i[s].length;n--;)r=i[s][n],r.once===!0&&this.removeListener(e,r.listener),a=r.listener.apply(this,t||[]),a===this._getOnceReturnValue()&&this.removeListener(e,r.listener);return this},n.trigger=r("emitEvent"),n.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},n.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},n._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},n._getEvents=function(){return this._events||(this._events={})},e.noConflict=function(){return s.EventEmitter=a,e},"function"==typeof define&&define.amd?define("eventEmitter/EventEmitter",[],function(){return e}):"object"==typeof module&&module.exports?module.exports=e:this.EventEmitter=e}).call(this),function(){var e={serialize:function(e,r,n){n=n||{};var s=n.encode||t,a=[e+"="+s(r)];if(null!=n.maxAge){var i=n.maxAge-0;if(isNaN(i))throw new Error("maxAge should be a Number");a.push("Max-Age="+i)}return n.domain&&a.push("Domain="+n.domain),n.path&&a.push("Path="+n.path),n.expires&&a.push("Expires="+n.expires.toUTCString()),n.httpOnly&&a.push("HttpOnly"),n.secure&&a.push("Secure"),a.join("; ")},parse:function(e,t){t=t||{};var n={},s=e.split(/; */),a=t.decode||r;return s.forEach(function(e){var t=e.indexOf("=");if(!(0>t)){var r=e.substr(0,t).trim(),s=e.substr(++t,e.length).trim();if('"'==s[0]&&(s=s.slice(1,-1)),void 0==n[r])try{n[r]=a(s)}catch(i){n[r]=s}}}),n}},t=encodeURIComponent,r=decodeURIComponent;"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define&&define.amd?define("cookie-js/cookie",[],function(){return e}):window.cookiejs=e}(),function(e,t){"function"==typeof define&&define.amd?define("analytics",t):e.analytics=t()}(this,function(){function e(e){var r=/^(a|an|and|as|at|but|by|en|for|if|in|nor|of|on|or|per|the|to|vs?\.?|via)$/i;return e=t(e),e.replace(/[A-Za-z0-9\u00C0-\u00FF]+[^\s-]*/g,function(e,t,n){return t>0&&t+e.length!==n.length&&e.search(r)>-1&&":"!==n.charAt(t-2)&&("-"!==n.charAt(t+e.length)||"-"===n.charAt(t-1))&&n.charAt(t-1).search(/[^\s-]/)<0?e.toLowerCase():e.substr(1).search(/[A-Z]|\../)>-1?e:e.charAt(0).toUpperCase()+e.substr(1)})}function t(e){return e.replace(/^\s+|\s+$/g,"")}function r(e){return/[^@]+@[^@]+/.test(e)}function n(e){console.warn("[analytics] "+e)}function s(e){if("function"==typeof ga){var t={hitType:"event",eventCategory:u,eventAction:e.action};e.label&&(t.eventLabel=e.label),(e.value||0===e.value)&&(t.eventValue=e.value),e.nonInteraction===!0&&(t.nonInteraction=1),ga("send",t)}var r=["_trackEvent",u,e.action];e.label&&(r[3]=e.label),(e.value||0===e.value)&&(r[4]=e.value),e.nonInteraction===!0&&(r[5]=!0),_gaq.push(r)}function a(a,i){i=i||{};var o={},l=i.label,c=i.value,d=i.noninteraction||i.nonInteraction;return a?(r(a)&&(n("`action` arg looks like an email address, redacting."),a=m),o.action=e(a),l&&("string"!=typeof l?n("Expected `label` arg to be a String."):(r(l)&&(n("`label` arg looks like an email address, redacting."),l=m),o.label=t(l))),(c||0===c)&&("number"!=typeof c?n("Expected `value` arg to be a Number."):o.value=0|c),d&&("boolean"!=typeof d?n("Expected `noninteraction` arg to be a Boolean."):o.nonInteraction=d===!0),void s(o)):void n("Expected `action` arg.")}function i(e){return/^\/virtual\//.test(e)?e:(e=e.replace(/^[/]?/,"/"),"/virtual"+e)}function o(e){if("function"==typeof ga){var t={hitType:"pageview",page:e.virtualPagePath};ga("send",t)}var r=["_trackPageview",e.virtualPagePath];_gaq.push(r)}function l(e){if(!e)return void n("Expected `virtualPagePath` arg.");e=t(e);var r={};r.virtualPagePath=i(e),o(r)}function c(e){var t=["_trackEvent",e.action];if(e.revenue){var r={revenue:e.revenue};t[2]=r}optimizely.push(t)}function d(e,r){r=r||{};var s={},a=r.valueInCents;return e?(s.action=t(e),a&&("number"==typeof a&&a%1===0?s.revenue=a:n("Expected `valueInCents` arg to be an integer.")),void c(s)):void n("Expected `action` arg.")}this._gaq||(this._gaq=[]),this.optimizely||(this.optimizely=[]);var u=location.hostname,m="REDACTED (Potential Email Address)";return{event:a,virtualPageview:l,conversionGoal:d}}),function(e,t){"function"==typeof define&&define.amd?define("webmaker-auth-client",["eventEmitter/EventEmitter","cookie-js/cookie","analytics"],t):e.Localized=t(window.EventEmitter,window.cookiejs,window.analytics)}(this,function(e,t,r){var n=/^[abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\-]{1,20}$/;return function(s){window.localStorage||console.error("Local storage must be supported for instant login.");var a=this,i={domain:location.hostname.split(".").slice(-2).join("."),path:"/",secure:"https:"===location.protocol,expires:new Date(Date.now()+6048e5)},o=/ref=((?:\w|-)+)/.exec(window.location.search),l=t.parse(document.cookie).webmakerReferral;o&&(o=o[1]),s=s||{},s.paths=s.paths||{},a.emitter=new e,a.host=s.host||"",a.paths=s.paths||{},a.paths.authenticate=s.paths.authenticate||"/authenticate",a.paths.create=s.paths.create||"/create",a.paths.verify=s.paths.verify||"/verify",a.paths.logout=s.paths.logout||"/logout",a.paths.checkUsername=s.paths.checkUsername||"/check-username",a.urls={authenticate:a.host+a.paths.authenticate,create:a.host+a.paths.create,verify:a.host+a.paths.verify,logout:a.host+a.paths.logout,checkUsername:a.host+a.paths.checkUsername},a.audience=s.audience||window.location.protocol+"//"+window.location.host,a.prefix=s.prefix||"webmaker-",a.timeout=s.timeout||10,a.localStorageKey=a.prefix+"login",a.csrfToken=s.csrfToken,a.withCredentials=s.withCredentials===!1?!1:!0,o&&l!==o&&(document.cookie=t.serialize("webmakerReferral",o,i),l=o),a.clearReferrerCookie=function(){var e=i;e.expires=new Date(Date.now()-1e4),document.cookie=t.serialize("webmakerReferral","expire",e)},a.handleNewUserUI=s.handleNewUserUI===!1?!1:!0,a.analytics={},a.analytics.webmakerNewUserCancelled=function(){r.event("Webmaker New User Cancelled")},a.modal={},a.modal.element=document.getElementById("webmaker-login-new-user"),a.modal.dismissSelector="[data-dismiss]",a.modal.createSelector=".create-user",a.modal.createBtnOnClick=function(){},a.modal.checkUsernameOnChange=function(){var e=a.modal.element.querySelector(".username-taken-error"),t=a.modal.element.querySelector(".username-invalid-error"),r=a.modal.element.querySelector(".username-required-error"),n=a.modal.element.querySelector(".username-group"),s=this.value;return s?void a.checkUsername(s,function(s,a){s&&"Username taken"===a?(n.classList.add("has-error"),n.classList.remove("has-success"),e.classList.remove("hidden"),r.classList.add("hidden"),t.classList.add("hidden")):s&&"Username invalid"===a?(n.classList.add("has-error"),n.classList.remove("has-success"),t.classList.remove("hidden"),e.classList.add("hidden"),r.classList.add("hidden")):(n.classList.remove("has-error"),n.classList.add("has-success"),e.classList.add("hidden"),r.classList.add("hidden"),t.classList.add("hidden"))}):(n.classList.remove("has-success"),n.classList.add("has-error"),e.classList.add("hidden"),r.classList.remove("hidden"),void t.classList.add("hidden"))},a.modal.setup=function(e){var t=a.modal.element.querySelector(a.modal.createSelector),r=a.modal.element.querySelectorAll(a.modal.dismissSelector),n=a.modal.element.querySelector(".username-group"),s=a.modal.element.querySelector(".agree-group"),i=a.modal.element.querySelector(".username-taken-error"),o=a.modal.element.querySelector(".username-required-error"),l=a.modal.element.querySelector(".username-invalid-error"),c=a.modal.element.querySelector(".agree-error"),d=a.modal.element.querySelector('[name="username"]'),u=a.modal.element.querySelector('[name="agreeToTerms"]'),m=a.modal.element.querySelector('[name="mailingList"]'),h=a.modal.element.querySelector("[name=supportedLocales]");t.removeEventListener("click",a.modal.createBtnOnClick,!1),d.addEventListener("change",a.modal.checkUsernameOnChange,!1),a.modal.createBtnOnClick=function(){var t=!1;u.checked||(s.classList.add("has-error"),c.classList.remove("hidden"),t=!0),d.value||(n.classList.remove("has-success"),n.classList.add("has-error"),i.classList.add("hidden"),o.classList.remove("hidden"),l.classList.add("hidden"),t=!0),t||a.checkUsername(d.value,function(t,r){t&&"Username taken"===r?(n.classList.add("has-error"),n.classList.remove("has-success"),i.classList.remove("hidden"),o.classList.add("hidden"),l.classList.add("hidden")):t&&"Username invalid"===r?(n.classList.add("has-error"),n.classList.remove("has-success"),l.classList.remove("hidden"),i.classList.add("hidden"),o.classList.add("hidden")):a.createUser({assertion:e,user:{username:d.value,mailingList:m.checked,prefLocale:h.value}},function(e){return e?void console.error(e):(i.classList.add("hidden"),o.classList.add("hidden"),l.classList.add("hidden"),c.classList.add("hidden"),n.classList.remove("has-error"),n.classList.remove("has-success"),s.classList.remove("has-error"),void a.modal.close())})})};for(var v=0;v<r.length;v++)r[v].removeEventListener("click",a.modal.close,!1),r[v].addEventListener("click",a.modal.close,!1);t.addEventListener("click",a.modal.createBtnOnClick,!1)},a.modal.open=function(){a.modal.element.classList.add("in"),a.modal.element.style.display="block",a.modal.element.setAttribute("aria-hidden",!1)},a.modal.close=function(e){e&&a.analytics.webmakerNewUserCancelled(),a.modal.element.classList.remove("in"),a.modal.element.style.display="none",a.modal.element.setAttribute("aria-hidden",!0)},a.on=function(e,t){a.emitter.addListener(e,t)},a.off=function(e,t){a.emitter.removeListener(e,t)},a.checkUsername=function(e,t){if(!n.test(e))return t(!0,"Username invalid");var r=new XMLHttpRequest,s=JSON.stringify({username:e});r.open("POST",a.urls.checkUsername,!0),r.withCredentials=a.withCredentials,r.setRequestHeader("Content-type","application/json"),r.setRequestHeader("X-CSRF-Token",a.csrfToken),r.onreadystatechange=function(){if(4===r.readyState&&200===r.status){var e=JSON.parse(r.responseText);e.exists?t(!0,"Username taken"):t(!1,"Username not taken")}else 4===r.readyState&&r.status&&(r.status>=400||r.status<200)?(a.emitter.emitEvent("error",[r.responseText]),t(!1,"Error checking username")):4===r.readyState&&(a.emitter.emitEvent("error",["Looks like "+a.urls.checkUsername+" is not responding..."]),t(!1,"Error checking username"))},r.send(s)},a.createUser=function(e,t){e.user.referrer=l;var n=new XMLHttpRequest,s=JSON.stringify({assertion:e.assertion,audience:a.audience,user:e.user});t=t||function(){},n.open("POST",a.urls.create,!0),n.withCredentials=a.withCredentials,n.setRequestHeader("Content-type","application/json"),n.setRequestHeader("X-CSRF-Token",a.csrfToken),n.onreadystatechange=function(){if(4===n.readyState&&200===n.status){var e=JSON.parse(n.responseText);e.user?(a.storage.set(e.user),a.emitter.emitEvent("login",[e.user,"user created"]),r.event("Webmaker New User Created",{nonInteraction:!0}),r.conversionGoal("WebmakerNewUserCreated"),a.clearReferrerCookie(),t(null,e.user)):(a.emitter.emitEvent("error",[n.responseText]),t(n.responseText))}else 4===n.readyState&&n.status&&(n.status>=400||n.status<200)?(a.emitter.emitEvent("error",[n.responseText]),t(n.responseText)):4===n.readyState&&(a.emitter.emitEvent("error",["Looks like "+a.urls.create+" is not responding..."]),t(n.responseText))},n.send(s)},a.verify=function(){a.storage.get()&&a.emitter.emitEvent("login",[a.storage.get(),"restored"]);var e=a.storage.get("email"),t=new XMLHttpRequest;t.open("POST",a.urls.verify,!0),t.withCredentials=a.withCredentials,t.setRequestHeader("Content-type","application/json"),t.setRequestHeader("X-CSRF-Token",a.csrfToken),t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){var r=JSON.parse(t.responseText);e&&r.email===e?(a.emitter.emitEvent("login",[r.user,"verified"]),a.storage.set(r.user)):r.user?(a.emitter.emitEvent("login",[r.user,"email mismatch"]),a.storage.set(r.user)):(a.emitter.emitEvent("logout"),a.storage.clear())}else 4===t.readyState&&t.status&&(t.status>=400||t.status<200)?a.emitter.emitEvent("error",[t.responseText]):4===t.readyState&&a.emitter.emitEvent("error",["Looks like "+a.urls.verify+" is not responding..."])},t.send()},a.login=function(){return window.navigator.id?(r.event("Webmaker Login Clicked"),window.removeEventListener("focus",a.verify,!1),void window.navigator.id.get(function(e){if(!e)return a.emitter.emitEvent("error",["No assertion was received"]),void r.event("Persona Login Cancelled");r.event("Persona Login Succeeded");var t={referrer:l},n=new XMLHttpRequest,s=JSON.stringify({audience:a.audience,assertion:e,user:t});if(a.timeout)var i=setTimeout(function(){n.abort(),a.emitter.emitEvent("error",["The request for a token timed out after "+a.timeout+" seconds"])},1e3*a.timeout);n.open("POST",a.urls.authenticate,!0),n.withCredentials=a.withCredentials,n.setRequestHeader("Content-type","application/json"),n.setRequestHeader("X-CSRF-Token",a.csrfToken),n.onreadystatechange=function(){if(a.timeout&&i&&clearTimeout(i),4===n.readyState&&200===n.status){var t=JSON.parse(n.responseText);t.error&&a.emitter.emitEvent("error",[t.error]),t.user&&(a.storage.set(t.user),a.emitter.emitEvent("login",[t.user]),r.event("Webmaker Login Succeeded"),a.clearReferrerCookie(),window.addEventListener("focus",a.verify,!1)),t.email&&!t.user&&(a.emitter.emitEvent("newuser",[e,t.email]),r.event("Webmaker New User Started"),a.handleNewUserUI&&(a.modal.setup(e,t.email),a.modal.open())),t.err&&a.emitter.emitEvent("error",[t.err])}else 4===n.readyState&&n.status&&(n.status>=400||n.status<200)?a.emitter.emitEvent("error",[n.responseText]):4===n.readyState&&a.emitter.emitEvent("error",["Looks like "+a.urls.authenticate+" is not responding..."])},n.send(s)},{backgroundColor:"#E3EAEE",privacyPolicy:"https://webmaker.org/privacy",siteLogo:"https://stuff.webmaker.org/persona-assets/logo-webmaker.png",siteName:"Mozilla Webmaker",termsOfService:"https://webmaker.org/terms"})):void console.error("No persona found. Did you include include.js?")},a.logout=function(){r.event("Webmaker Logout Clicked"),window.removeEventListener("focus",a.verify,!1);var e=new XMLHttpRequest;e.open("POST",a.urls.logout,!0),e.withCredentials=a.withCredentials,e.setRequestHeader("X-CSRF-Token",a.csrfToken),e.onreadystatechange=function(){4===e.readyState&&200===e.status?(a.emitter.emitEvent("logout"),a.storage.clear(),window.addEventListener("focus",a.verify,!1)):4===e.readyState&&e.status&&(e.status>=400||e.status<200)?a.emitter.emitEvent("error",[e.responseText]):4===e.readyState&&a.emitter.emitEvent("error",["Looks like "+a.urls.logout+" is not responding..."])},e.send(null)},a.storage={get:function(e){var t=JSON.parse(localStorage.getItem(a.localStorageKey));if(t)return e?t[e]:t},set:function(e){var t=JSON.parse(localStorage.getItem(a.localStorageKey))||{};for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);localStorage.setItem(a.localStorageKey,JSON.stringify(t))},clear:function(){delete localStorage[a.localStorageKey]}}}});